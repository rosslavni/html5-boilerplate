<?xml version="1.0"?>
<project name="Boilerplate Build" default="build" basedir="../"> <!-- one back since we're in build/ -->
  <!-- load property files -->
  <property file="./build/build.properties"/>
  <property file="./build/default.properties"/>
  
  <target name="current-number">
    <echo>Current build number:${build.number}</echo>
  </target>
  
  <!-- Increase the current build number by one and set build date -->
  <!-- as per http://www.ibmpressbooks.com/articles/article.aspx?p=519946 -->
  <target name="rev">
    <echo message="Rev the build number..."/>
    <propertyfile file="./build/${html5boilerplate.build.info}" comment="Build Information File - DO NOT CHANGE">
      <entry key="build.number" type="int" default="0000" operation="+" pattern="0000"/>
      <entry key="build.date" type="date" value="now" pattern="dd.MM.yyyy HH:mm"/>
    </propertyfile>
  </target>
  
  <target name="clean">
    <echo message="Cleaning up previous build directory..."/>
    <delete dir="./publish/"/>
  </target>
  
  <target name="copy" depends="clean">
    <echo message="Copying over new files..."/>
    <copy todir="./publish">
      <fileset dir="./">
        <exclude name=".gitignore"/>
        <exclude name="README.markdown"/>
        <exclude name="**/.git/**"/>
        <exclude name="**/build/**"/>
        <exclude name="**/test/**"/>
        <exclude name="**/demo/**"/>
      </fileset>
    </copy>
  </target>
  
  <target name="usemin" depends="copy">
    <echo message="Switching to minified js files..."/>
    
    <!-- switch from a regular jquery to minified-->
    <replaceregexp match="jquery-(\d|\d(\.\d)+)\.js" replace="jquery-\1.min.js" file="./publish/index.html" flags=""/>
    <!-- switch any google CDN reference to minified -->
    <replaceregexp match="(\d|\d(\.\d)+)\/jquery\.js" replace="\1/jquery.min.js" file="./publish/index.html" flags=""/>
   
  </target>
  
  <target name="scripts" depends="copy">
    <echo message="Concatenating and minifying javascript"/>
    <concat destfile="./publish/js/script-${build.number}.js">
      <fileset file="./js/jquery-1.4.2.js"/>
      <fileset file="./js/plugins.js"/>
      <fileset file="./js/script.js"/>
    </concat>
    <apply executable="java" parallel="false">
      <fileset dir="./publish/js/" includes="script-${build.number}.js"/>
      <arg line="-jar"/>
      <arg path="./build/tools/yuicompressor-2.4.2.jar"/>
      <srcfile/>
      <arg line="-o"/>
      <mapper type="glob" from="script-${build.number}.js" to="../publish/js/script-${build.number}.min.js"/>
      <targetfile/>
    </apply>
    <!-- <delete file="./publish/js/script-${build.number}.js"/> View source has a posse. -->
  </target>
  
  <target name="css" depends="copy">
    <echo message="Minifying css..."/>
    <concat destfile="./publish/css/style-${build.number}.css">
      <fileset file="./css/style.css"/>
    </concat>
    <apply executable="java" parallel="false">
      <fileset dir="./publish/css/" includes="style-${build.number}.css"/>
      <arg line="-jar"/>
      <arg path="./build/tools/yuicompressor-2.4.2.jar"/>
      <srcfile/>
      <arg line="-o"/>
      <mapper type="glob" from="style-${build.number}.css" to="../publish/css/style-${build.number}.min.css"/>
      <targetfile/>
    </apply>
    <replace token="style.css" value="style-${build.number}.min.css" file="./publish/index.html"/>
    <!-- <delete file="./publish/css/style-${build.number}.css"/> -->
  </target>
  
  <target name="imagespng" depends="copy">
    <echo message="Optimizing images"/>
    <apply executable="optipng" osfamily="unix">
      <arg value="-o7"/>
      <fileset dir="./publish/images">
        <exclude name="*.jpg"/>
      </fileset>
    </apply>
    <apply executable="optipng" osfamily="mac">
      <arg value="-o7"/>
      <fileset dir="./publish/images">
        <exclude name="*.jpg"/>
      </fileset>
    </apply>
    <apply executable="tools/optipng-0.6.4-exe/optipng.exe" osfamily="windows">
      <arg value="-o7"/>
      <fileset dir="./publish/images">
        <exclude name="*.jpg"/>
      </fileset>
    </apply>
  </target>
  
  <target name="imagesjpg" depends="copy">
    <echo message="Clean up those jpgs..."/>
    <apply executable="jpegtran" osfamily="unix">
      <fileset dir="./publish/images/" includes="*.jpg"/>
      <arg value="-copy"/>
      <!-- change 'all to 'none' in order to strip metadata 
            only do so if you own copyright to the image -->
      <arg value="all"/>
      <srcfile/>
      <targetfile/>
      <!-- you may want to flag optimized images. If so, do it here. Otherwise change this to type="identity" -->
      <mapper type="glob" from="*.jpg" to="../publish/images/*.jpg"/>
    </apply>
    <apply executable="jpegtran" osfamily="mac">
      <fileset dir="./publish/images/" includes="*.jpg"/>
      <arg value="-copy"/>
      <!-- change 'all to 'none' in order to strip metadata 
            only do so if you own copyright to the image -->
      <arg value="all"/>
      <srcfile/>
      <targetfile/>
      <!-- you may want to flag optimized images. If so, do it here. Otherwise change this to type="identity" -->
      <mapper type="glob" from="*.jpg" to="../publish/images/*.jpg"/>
    </apply>
    <apply executable="tools/jpegtran.exe" osfamily="windows">
      <fileset dir="./publish/images/" includes="*.jpg"/>
      <arg value="-copy"/>
      <!-- change 'all to 'none' in order to strip metadata 
            only do so if you own copyright to the image -->
      <arg value="all"/>
      <srcfile/>
      <targetfile/>
      <!-- you may want to flag optimized images. If so, do it here. Otherwise change this to type="identity" -->
      <mapper type="glob" from="*.jpg" to="../publish/images/*.jpg"/>
    </apply>
  </target>
  
  <target name="html" depends="scripts">
    <echo message="Clean up the html..."/>
    <!-- style.css replacement handled as a replacetoken above -->
    <replaceregexp match="&lt;!-- scripts concatenated [\d\w\s\W]*?!-- end concatenated and minified scripts--&gt;" file="./publish/index.html" replace="&lt;script src='js/script-${build.number}.min.js\'&gt;&lt;/script&gt;" flags="m"/>
    <replaceregexp match="&lt;!-- yui profiler[\d\w\s\W]*?end profiling code --&gt;" file="./publish/index.html" replace=" " flags="m"/>

    <!-- html minification: -->
    <!-- We'll remove comments for now and that's it.. -->
    <replaceregexp match="&lt;!-- [\d\w\s\W]*?--&gt;" replace=" " flags="gm">
      <fileset dir="./publish/">
        <filename name="**/*.html"/>
        <!-- match all .html files within publish -->
      </fileset>
    </replaceregexp>
    <!-- any ! comments will go back to normal comments -->
    <replaceregexp match="&lt;!--! " file="./publish/index.html" replace="&lt;!-- " flags=""/>
  </target>
  
  <!-- separated as a task if you want to avoid HTML compression. For example, if you want to produce a build kit. -->
  <target name="htmlcompress" depends="html" >
    <apply executable="java" parallel="false" force="true" dest="./publish/" >
      <fileset dir="./publish/" includes="*.html"/>
      <arg value="-jar"/>
      <arg path="./build/tools/htmlcompressor-0.9.1.jar"/>
      <arg value="--preserve-comments"/>
      <arg line="--type html"/>
      <arg line="--compress-js"/>
      <arg line="--compress-css"/>
      <srcfile/>
      <arg value="-o"/>
      <mapper type="glob" from="*.html" to="../publish/*.html"/>    
      <targetfile/>
    </apply>
  </target>
  
  <target name="text" depends="current-number,clean,rev,copy,usemin,scripts,css,html,htmlcompress" description="Concats files, runs YUI Compressor on them and makes magic happen."/>
  <target name="build" depends="current-number,clean,rev,copy,usemin,scripts,css,html,htmlcompress,imagespng,imagesjpg" description="Concats files, runs YUI Compressor, optimizes images. There is much rejoicing."/>

</project>
