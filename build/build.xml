<?xml version="1.0"?>
<project name="Boilerplate Build" default="build" basedir="../"> <!-- one back since we're in build/ -->
  <property file="./build/build.properties"/>
  <property name="build.number" value="${build.number}"/>
  <target name="current-number">
    <echo>Current build number:${build.number}</echo>
  </target>
  <target name="rev">
    <echo message="Rev the build number..."/>
    <propertyfile file="./build/build.properties">
      <entry key="build.number" type="int" operation="+" value="1" pattern="000"/>
    </propertyfile>
  </target>
  <target name="clean">
    <echo message="Cleaning up previous build directory..."/>
    <delete dir="./publish/"/>
  </target>
  <target name="copy" depends="clean">
    <echo message="Copying over new files..."/>
    <copy todir="./publish">
      <fileset dir="./">
        <exclude name=".gitignore"/>
        <exclude name="build.xml"/>
        <exclude name="**/.git/**"/>
        <exclude name="**/build/**"/>
        <exclude name="**/test/**"/>
      </fileset>
    </copy>
  </target>
  <target name="scripts" depends="copy">
    <echo message="Concatenating and minifying javascript"/>
    <concat destfile="./publish/js/script-${build.number}.js">
      <fileset file="./js/jquery-1.4.2.js"/>
      <fileset file="./js/plugins.js"/>
      <fileset file="./js/script.js"/>
    </concat>
    <apply executable="java" parallel="false">
      <fileset dir="publish/js/" includes="script-${build.number}.js"/>
      <arg line="-jar"/>
      <arg path="./build/tools/yuicompressor-2.4.2.jar"/>
      <srcfile/>
      <arg line="-o"/>
      <mapper type="glob" from="script-${build.number}.js" to="../publish/js/script-${build.number}.min.js"/>
      <targetfile/>
    </apply>
    <!-- <delete file="./publish/js/script-${build.number}.js"/> View source has a posse. -->
  </target>
  <target name="css" depends="copy">
    <echo message="Minifying css..."/>
    <concat destfile="./publish/css/style-${build.number}.css">
      <fileset file="./css/style.css"/>
    </concat>
    <apply executable="java" parallel="false">
      <fileset dir="publish/css/" includes="style-${build.number}.css"/>
      <arg line="-jar"/>
      <arg path="./build/tools/yuicompressor-2.4.2.jar"/>
      <srcfile/>
      <arg line="-o"/>
      <mapper type="glob" from="style-${build.number}.css" to="../publish/css/style-${build.number}.min.css"/>
      <targetfile/>
    </apply>
    <replace token="style.css" value="style-${build.number}.min.css" file="./publish/index.html"/>
    <!-- <delete file="./publish/css/style-${build.number}.css"/> -->
  </target>
  <target name="imagespng" depends="copy">
    <echo message="Optimizing images"/>
    <apply executable="optipng" osfamily="unix">
      <arg value="-o7"/>
      <fileset dir="./publish/images">
        <exclude name="*.jpg"/>
      </fileset>
    </apply>
    <apply executable="optipng" osfamily="mac">
      <arg value="-o7"/>
      <fileset dir="./publish/images">
        <exclude name="*.jpg"/>
      </fileset>
    </apply>
    <apply executable="build\tools\optipng-0.6.4-exe\optipng.exe" osfamily="windows">
      <arg value="-o7"/>
      <fileset dir="./publish/images">
        <exclude name="*.jpg"/>
      </fileset>
    </apply>
  </target>
  <target name="imagesjpg" depends="copy">
    <echo message="Clean up those jpgs..."/>
    <apply executable="jpegtran" osfamily="unix">
      <fileset dir="./publish/images/" includes="*.jpg"/>
      <arg value="-copy"/>
      <!-- change this to 'none' in order to strip meta -->
      <!--only do so if you own copyright to the image -->
      <arg value="all"/>
      <srcfile/>
      <targetfile/>
      <!-- you may want to flag optimized images. If so, do it here -->
      <mapper type="glob" from="*.jpg" to="./publish/images/*.jpg"/>
    </apply>
    <apply executable="jpegtran" osfamily="mac">
      <fileset dir="./publish/images/" includes="*.jpg"/>
      <arg value="-copy"/>
      <!-- change this to 'none' in order to strip meta -->
      <!--only do so if you own copyright to the image -->
      <arg value="all"/>
      <srcfile/>
      <targetfile/>
      <!-- you may want to flag optimized images. If so, do it here -->
      <mapper type="glob" from="*.jpg" to="./publish/images/*.jpg"/>
    </apply>
    <apply executable="build\tools\jpegtran.exe" osfamily="windows">
      <fileset dir="./publish/images/" includes="*.jpg"/>
      <arg value="-copy"/>
      <!-- change this to 'none' in order to strip meta -->
      <!--only do so if you own copyright to the image -->
      <arg value="all"/>
      <srcfile/>
      <targetfile/>
      <!-- you may want to flag optimized images. If so, do it here -->
      <mapper type="glob" from="*.jpg" to="./publish/images/*.jpg"/>
    </apply>
  </target>
  <target name="html" depends="scripts">
    <echo message="Clean up the html..."/>
    
    <!-- style.css replacement handled as a replacetoken above -->
    <replaceregexp match="&lt;!-- scripts concatenated [\d\w\s\W]*?!-- end concatenated and minified scripts--&gt;" file="./publish/index.html" replace="&lt;script src='js/script-${build.number}.min.js\'&gt;&lt;/script&gt;" flags="m"/>
    <replaceregexp match="&lt;!-- yui profiler[\d\w\s\W]*?end profiling code --&gt;" file="./publish/index.html" replace=" " flags="m"/>
    
    
    <!-- html minification: -->
    <!-- We'll remove comments for now and that's it.. -->
    <replaceregexp match="&lt;!-- [\d\w\s\W]*?--&gt;" replace=" " flags="gm">
      <fileset dir="./publish/">
        <filename name="**/*.html"/> <!-- match all .html files within publish -->
      </fileset>
    </replaceregexp>
    <!-- In the future we'd like to integrate kangax's html minifier: github.com/lrbabe/html-minifier -->
    
    
  </target>
  <target name="text" depends="current-number,clean,rev,copy,scripts,css,html" description="Concats files, runs YUI Compressor on them and makes magic happen."/>
  <target name="build" depends="current-number,clean,rev,copy,scripts,css,html,imagespng,imagesjpg" description="Concats files, runs YUI Compressor, optimizes images. There is much rejoicing."/>
</project>
